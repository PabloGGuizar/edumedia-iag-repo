<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio de aplicaciones educativas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-top-width: 4px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .action-btn {
            transition: all 0.2s ease-in-out;
        }
        .action-btn.active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
            border-color: #3b82f6; /* blue-600 */
        }
        .filter-btn {
            transition: all 0.2s ease-in-out;
            border: 1px solid #d1d5db; /* gray-300 */
        }
        .filter-btn.active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
            border-color: #3b82f6; /* blue-600 */
        }
        .filter-btn:not(.active):hover {
            background-color: #f3f4f6; /* gray-100 */
            border-color: #9ca3af; /* gray-400 */
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .arrow { transform: rotate(90deg); }
        .keyword-tag { cursor: pointer; }
        .keyword-tag:hover, .keyword-tag.active {
            background-color: #38bdf8; /* sky-500 */
            color: white;
        }
        .filter-link {
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
            color: #4b5563; /* gray-600 */
        }
        .filter-link:hover {
            color: #1d4ed8; /* blue-700 */
            background-color: #eff6ff; /* blue-50 */
        }
        .hidden { display: none; }
        #copy-confirm-msg {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .favorite-btn svg {
            transition: all 0.2s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .favorite-btn:hover svg {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Encabezado -->
        <header class="text-center mb-4 p-6 rounded-xl bg-gradient-to-b from-blue-50 to-gray-50">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Repositorio de aplicaciones educativas</h1>
            <p class="mt-4 text-lg text-gray-600">
                Una colección de aplicaciones y recursos educativos creados por la comunidad 
                <a href="https://t.me/vceduca" target="_blank" class="text-blue-600 hover:underline font-semibold">Vibe Coding Educativo</a>.
            </p>
            <p class="mt-2 text-sm text-gray-500">
                Para añadir tu aplicación, utiliza el enlace fijado en el grupo.
            </p>
        </header>

        <!-- Barra de Búsqueda y Filtros -->
        <div class="flex flex-col md:flex-row gap-4 items-center mb-4">
            <!-- Búsqueda libre -->
            <div class="relative w-full md:flex-grow">
                <label for="search-input" class="sr-only">Búsqueda libre</label>
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                     <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                <input type="text" id="search-input" placeholder="Buscar por todos los campos..." class="w-full p-2 pl-10 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button id="clear-search-btn" title="Limpiar búsqueda" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden text-gray-500 hover:text-gray-700 focus:outline-none">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <!-- Botones de acción -->
            <div class="flex-shrink-0 flex gap-2 w-full md:w-auto">
                 <button id="toggle-favorites-btn" title="Mostrar solo favoritos" class="action-btn flex flex-grow justify-center items-center gap-2 bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 shadow-sm border border-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    <span class="hidden sm:inline">Favoritos</span>
                </button>
                <button id="toggle-filters-btn" title="Mostrar/ocultar filtros" class="action-btn flex flex-grow justify-center items-center gap-2 bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 shadow-sm border border-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                    <span>Filtros</span>
                </button>
                 <button id="help-btn" title="Ayuda sobre filtros por URL" class="flex-shrink-0 flex justify-center items-center bg-gray-500 text-white font-semibold p-2.5 rounded-lg hover:bg-gray-600 transition shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </button>
            </div>
        </div>

        <!-- Panel de Filtros (Colapsable) -->
        <div id="filter-panel" class="bg-white p-4 sm:p-6 rounded-xl shadow-sm mb-8 sticky top-4 z-10 border border-gray-200 hidden">
            <div id="filters-container" class="space-y-4"></div>
            <div class="mt-6 border-t pt-4 flex justify-end">
                 <button id="reset-filters-btn" class="w-full sm:w-auto px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">Limpiar Filtros</button>
            </div>
        </div>
        
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 min-h-[2rem] gap-4">
            <div id="results-counter" class="text-sm text-gray-600 font-medium order-2 sm:order-1"></div>
            <div id="actions-bar" class="hidden order-1 sm:order-2 flex items-center gap-4">
                <button id="share-url-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                    Compartir URL
                </button>
                <button id="clear-all-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                    Limpiar todo
                </button>
            </div>
        </div>
        <div id="active-filters-display" class="flex flex-wrap gap-2 mb-4"></div>

        <!-- Mensajes -->
        <div id="loading-message" class="flex flex-col items-center justify-center text-center py-20">
            <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-lg text-gray-600 font-semibold">Cargando aplicaciones...</p>
        </div>
        <div id="error-message" class="hidden text-center py-10 bg-red-100 text-red-700 rounded-lg"><p class="text-lg">No se pudieron cargar los datos.</p><p class="text-sm mt-1">Asegúrate de que la URL del script es correcta y que se ha desplegado correctamente.</p></div>
        <div id="no-results-message" class="hidden text-center py-10"><p class="text-lg text-gray-500">No se encontraron aplicaciones.</p></div>
        <div id="no-favorites-message" class="hidden text-center py-10"><p class="text-lg text-gray-500">No tienes aplicaciones favoritas.<br><span class="text-sm">Haz clic en el corazón de una aplicación para añadirla.</span></p></div>


        <!-- Contenedor de las tarjetas -->
        <div id="apps-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </div>
    
    <footer class="text-center py-8 mt-12 border-t border-gray-200 text-sm text-gray-500 space-y-2">
        <p><a href="https://labia.tiddlyhost.com" target="_blank" class="text-blue-600 hover:underline font-semibold">Laboratorio de aplicaciones educativas</a></p>
        <p><a href="https://bilateria.org" target="_blank" class="text-blue-600 hover:underline font-semibold">Aplicación hecha por Juan José de Haro</a></p>
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="text-blue-600 hover:underline font-semibold">Licencia Creative Commons BY-SA</a></p>
    </footer>

    <!-- Modal de Ayuda -->
    <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 relative overflow-y-auto max-h-[90vh]">
            <button id="close-help-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-bold mb-4">Filtrado por URL</h3>
            <div class="space-y-4 text-gray-600">
                <p>Puedes compartir un enlace a esta página con filtros ya aplicados. La búsqueda no distingue mayúsculas/minúsculas ni acentos.</p>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">Parámetros disponibles:</h4>
                    <ul class="list-disc list-inside space-y-2">
                        <li><code class="text-sm bg-gray-100 p-1 rounded">search</code>, <code class="text-sm bg-gray-100 p-1 rounded">author</code>, <code class="text-sm bg-gray-100 p-1 rounded">subject</code>, <code class="text-sm bg-gray-100 p-1 rounded">level</code>, <code class="text-sm bg-gray-100 p-1 rounded">type</code>, <code class="text-sm bg-gray-100 p-1 rounded">platform</code>, <code class="text-sm bg-gray-100 p-1 rounded">keyword</code></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">Combinar filtros:</h4>
                    <ul class="list-disc list-inside space-y-2">
                        <li>Varios valores para una categoría (p.ej. nivel):<br><code class="text-sm bg-gray-100 p-1 rounded">?level=Primaria,Secundaria</code></li>
                        <li>Distintas categorías (p.ej. autor y área):<br><code class="text-sm bg-gray-100 p-1 rounded">?author=Juan Perez&subject=Matematicas</code></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div id="copy-confirm-msg" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-sm py-2 px-4 rounded-full opacity-0 -translate-y-5 pointer-events-none">
        ¡URL copiada al portapapeles!
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURACIÓN ---
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw_Mta5ICfJhOWXQTDHzvJ2Vfe0erKnVuW3rH6TZKbTn8kQLTtCubMKTOpn8OhlKjXi/exec';
            
            // --- State Variables ---
            let allApps = [];
            let favorites = new Set();
            let showingFavoritesOnly = false;
            let activeFilters = {
                area_conocimiento: new Set(), nivel_educativo: new Set(),
                tipo_recurso: new Set(), plataforma: new Set(),
                nombre_autor: new Set(), palabras_clave: new Set(),
            };
            
            // --- DOM Elements ---
            const elements = {
                loadingMsg: document.getElementById('loading-message'),
                errorMsg: document.getElementById('error-message'),
                noResultsMsg: document.getElementById('no-results-message'),
                noFavoritesMsg: document.getElementById('no-favorites-message'),
                appsContainer: document.getElementById('apps-container'),
                filtersContainer: document.getElementById('filters-container'),
                resultsCounter: document.getElementById('results-counter'),
                activeFiltersDisplay: document.getElementById('active-filters-display'),
                actionsBar: document.getElementById('actions-bar'),
                searchInput: document.getElementById('search-input'),
                clearSearchBtn: document.getElementById('clear-search-btn'),
                toggleFiltersBtn: document.getElementById('toggle-filters-btn'),
                toggleFavoritesBtn: document.getElementById('toggle-favorites-btn'),
                filterPanel: document.getElementById('filter-panel')
            };

            function normalizeString(str) {
                if (!str) return '';
                return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }

            function loadFavorites() {
                try {
                    const storedFavorites = localStorage.getItem('educationalAppsFavorites');
                    if (storedFavorites) {
                        favorites = new Set(JSON.parse(storedFavorites));
                    }
                } catch (e) {
                    console.error("Error loading favorites from localStorage", e);
                    favorites = new Set();
                }
            }

            function saveFavorites() {
                try {
                    localStorage.setItem('educationalAppsFavorites', JSON.stringify([...favorites]));
                } catch (e) {
                     console.error("Error saving favorites to localStorage", e);
                }
            }
            
            function setupFilters(apps) {
                const filterCategories = [
                    { id: 'area_conocimiento', name: 'Área de Conocimiento', multi: true, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>' },
                    { id: 'nivel_educativo', name: 'Nivel Educativo', multi: true, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 1.7.9 3.2 2.3 4.1"/><path d="M16 17a3 3 0 0 0-3-3 3 3 0 0 0-3 3v2h6v-2Z"/></svg>' },
                    { id: 'tipo_recurso', name: 'Tipo de Recurso', multi: true, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.28 2.22a2.22 2.22 0 0 0-3.14 0l-12 12a2.22 2.22 0 0 0 0 3.14l3.14 3.14a2.22 2.22 0 0 0 3.14 0l12-12a2.22 2.22 0 0 0 0-3.14Z"/><path d="m14 7 3 3"/><path d="M5.5 16.5 10 12"/></svg>' },
                    { id: 'plataforma', name: 'Plataforma', multi: false, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>'},
                    { id: 'nombre_autor', name: 'Autor', multi: false, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'},
                ];

                filterCategories.forEach(cat => {
                    const values = new Set(apps.flatMap(app => app[cat.id]?.split(',') || []).map(v => v.trim()).filter(Boolean));
                    if (values.size === 0) return;
                    
                    const sortedValues = Array.from(values).sort((a,b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
                    const details = document.createElement('details');
                    details.className = 'border-b border-gray-200 last:border-b-0 pb-4';
                    details.innerHTML = `
                        <summary class="flex justify-between items-center cursor-pointer py-2">
                            <div class="flex items-center gap-3"><span class="text-gray-500">${cat.icon}</span><span class="font-semibold text-gray-800">${cat.name}</span></div>
                            <span class="arrow transition-transform text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
                        </summary>
                        <div class="pt-3 flex flex-wrap gap-2" data-category="${cat.id}" data-multiselect="${cat.multi}">
                            ${sortedValues.map(value => `<button class="filter-btn text-sm font-medium py-1.5 px-3 rounded-full" data-filter="${value}">${value}</button>`).join('')}
                        </div>`;
                    elements.filtersContainer.appendChild(details);
                });
            }

            function getPlatformStyle(platform) {
                const STYLES = {'Gemini': 'border-purple-500', 'Claude': 'border-orange-500', 'ChatGPT': 'border-teal-500', 'Web (HTML/JS propio)': 'border-blue-500', 'GitHub Pages': 'border-black', 'Google Sites': 'border-sky-500', 'Default': 'border-gray-400'};
                if (!platform) return STYLES.Default;
                const key = Object.keys(STYLES).find(k => platform.includes(k) && k !== 'Default');
                return STYLES[key] || STYLES.Default;
            }

            function displayApps(apps) {
                elements.appsContainer.innerHTML = '';
                elements.noResultsMsg.classList.toggle('hidden', apps.length > 0 || (showingFavoritesOnly && favorites.size === 0));
                elements.noFavoritesMsg.classList.toggle('hidden', !showingFavoritesOnly || apps.length > 0 || favorites.size > 0);

                if (showingFavoritesOnly && favorites.size > 0 && apps.length === 0) {
                     elements.noResultsMsg.classList.remove('hidden');
                }
                
                elements.resultsCounter.textContent = `Mostrando ${apps.length} de ${allApps.length} aplicaciones.`;

                apps.forEach(app => {
                    const card = document.createElement('div');
                    card.className = `card bg-white rounded-lg shadow-sm overflow-hidden flex flex-col ${getPlatformStyle(app.plataforma)}`;
                    
                    const isFavorite = favorites.has(app.key);
                    const favClass = isFavorite ? 'text-red-500 fill-red-500' : 'text-gray-400 hover:text-red-500';
                    
                    const autorHtml = app.nombre_autor ? `<p class="text-sm text-gray-500 mb-3">por <span class="font-medium">${createFilterLink(app.nombre_autor, 'nombre_autor', false)}</span></p>` : '';

                    card.innerHTML = `
                        <div class="p-5 flex-grow flex flex-col relative">
                            <button class="favorite-btn absolute top-3 right-3 p-1 rounded-full bg-white/50 hover:bg-white/90 focus:outline-none focus:ring-2 focus:ring-red-400" title="Añadir/quitar de favoritos" data-key="${app.key}">
                                <svg class="w-6 h-6 transition-colors duration-200 ${favClass}" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 016.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
                            </button>
                            <p class="text-sm font-semibold text-gray-600 mb-3 pr-8">${app.plataforma || 'Sin plataforma'}</p>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${app.titulo_app || 'Sin título'}</h3>
                            ${autorHtml}
                            <p class="text-gray-600 text-sm mb-4 flex-grow">${app.descripcion_app || 'No hay descripción.'}</p>
                            <div class="text-xs text-gray-500 space-y-1 mt-auto">
                                ${app.nivel_educativo ? `<p><strong>Nivel:</strong> ${createFilterLink(app.nivel_educativo, 'nivel_educativo', true)}</p>` : ''}
                                ${app.area_conocimiento ? `<p><strong>Área:</strong> ${createFilterLink(app.area_conocimiento, 'area_conocimiento', true)}</p>` : ''}
                                ${app.licencia ? `<p><strong>Licencia:</strong> ${app.licencia}</p>` : ''}
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-200 bg-gray-50">
                            <div class="flex flex-wrap mb-3 min-h-[2rem]">${(app.palabras_clave || '').split(',').filter(k => k.trim()).map(k => `<span class="keyword-tag ${activeFilters.palabras_clave.has(k.trim()) ? 'active' : ''} bg-sky-100 text-sky-800 text-xs font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full" data-keyword="${k.trim()}">${k.trim()}</span>`).join('')}</div>
                            <a href="${app.url_app}" target="_blank" class="block w-full text-center bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors">Visitar Aplicación</a>
                        </div>`;
                    elements.appsContainer.appendChild(card);
                });
            }
            
            function createFilterLink(text, category, isMulti) {
                if (!text || typeof text !== 'string') {
                    return '';
                }
                return text.split(',').map(v => v.trim()).filter(Boolean).map(val => 
                    `<a href="#" class="filter-link" data-category="${category}" data-filter="${val}" data-multiselect="${isMulti}">${val}</a>`
                ).join(', ');
            }

            function applyAndDisplay() {
                const searchText = normalizeString(elements.searchInput.value);
                let appsToFilter = allApps;

                if (showingFavoritesOnly) {
                    appsToFilter = allApps.filter(app => favorites.has(app.key));
                }

                const filteredApps = appsToFilter.filter(app => {
                    // FIX: Ensure app is a valid object before processing
                    if (!app) return false;

                    if (searchText && !normalizeString(Object.values(app).join(' ')).includes(searchText)) {
                        return false;
                    }
                    for (const category in activeFilters) {
                        const selected = activeFilters[category];
                        if (selected.size === 0) continue;
                        const appValueString = app[category] ? normalizeString(app[category]) : '';
                        if (!appValueString) return false;
                        
                        const appValues = appValueString.split(',').map(s => s.trim());
                        const match = [...selected].every(filterVal => appValues.includes(normalizeString(filterVal)));
                        if (!match) return false;
                    }
                    return true;
                });
                
                displayApps(filteredApps);
                updateActiveFiltersDisplay();
            }
            
            function updateActiveFiltersDisplay() {
                elements.activeFiltersDisplay.innerHTML = '';
                let hasActiveFilter = false;

                Object.entries(activeFilters).forEach(([category, filterSet]) => {
                    if(filterSet.size === 0) return;
                    hasActiveFilter = true;
                    const catName = document.querySelector(`[data-category="${category}"]`)?.closest('details')?.querySelector('.font-semibold')?.textContent || 'Palabra Clave';
                    filterSet.forEach(filterValue => {
                        const tag = document.createElement('div');
                        tag.className = 'flex items-center bg-gray-200 text-gray-800 text-sm font-medium pl-3 pr-2 py-1 rounded-full';
                        tag.innerHTML = `<span>${catName}: ${filterValue}</span><button class="ml-2 text-gray-500 hover:text-gray-800" data-category="${category}" data-filter="${filterValue}" title="Eliminar filtro">&times;</button>`;
                        elements.activeFiltersDisplay.appendChild(tag);
                    });
                });
                
                const hasSearchText = elements.searchInput.value.length > 0;
                elements.actionsBar.classList.toggle('hidden', !hasActiveFilter && !hasSearchText);
            }
            
            function resetAllFilters(options = {}) {
                if (!options.preserveSearch) {
                    elements.searchInput.value = '';
                    elements.clearSearchBtn.classList.add('hidden');
                }
                for (const category in activeFilters) activeFilters[category].clear();
                
                document.querySelectorAll('.filter-btn.active').forEach(btn => btn.classList.remove('active'));
                elements.filtersContainer.querySelectorAll('details').forEach(d => { d.open = false; });
                
                showingFavoritesOnly = false;
                elements.toggleFavoritesBtn.classList.remove('active');

                applyAndDisplay();
            }
            
            const paramMapping = { subject: 'area_conocimiento', level: 'nivel_educativo', type: 'tipo_recurso', platform: 'plataforma', author: 'nombre_autor', keyword: 'palabras_clave', search: 'search' };

            function applyFiltersFromURL() {
                const params = new URLSearchParams(window.location.search);
                params.forEach((value, key) => {
                    const category = paramMapping[key.toLowerCase()];
                    if (!category) return;
                    
                    const valuesFromUrl = value.split(',');
                    if (category === 'search') {
                        elements.searchInput.value = value;
                        elements.clearSearchBtn.classList.toggle('hidden', !elements.searchInput.value);
                    } else if (activeFilters[category]) {
                         valuesFromUrl.forEach(urlVal => {
                            activeFilters[category].add(urlVal);
                            const normalized = normalizeString(urlVal);
                            document.querySelectorAll(`[data-category="${category}"] .filter-btn`).forEach(btn => {
                                if (normalizeString(btn.dataset.filter).includes(normalized)) btn.classList.add('active');
                            });
                        });
                    }
                });
            }

            function handleFilterClick(category, filter, isMulti) {
                const filterSet = activeFilters[category];
                if (!filterSet) return;
                
                if (isMulti) {
                    if (!filterSet.has(filter)) filterSet.add(filter);
                } else {
                    filterSet.clear();
                    filterSet.add(filter);
                }
                
                document.querySelectorAll(`.filter-btn[data-category="${category}"]`).forEach(btn => {
                    const shouldBeActive = filterSet.has(btn.dataset.filter);
                    btn.classList.toggle('active', shouldBeActive);
});

                applyAndDisplay();
            }

            function generateShareableURL() {
                const params = new URLSearchParams();
                const reverseMapping = Object.fromEntries(Object.entries(paramMapping).map(a => a.reverse()));
                if (elements.searchInput.value) params.set('search', elements.searchInput.value);
                for (const category in activeFilters) {
                    if (activeFilters[category].size > 0) {
                        const paramName = reverseMapping[category];
                        if (paramName) params.set(paramName, [...activeFilters[category]].join(','));
                    }
                }
                return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    const msg = document.getElementById('copy-confirm-msg');
                    msg.classList.remove('opacity-0', '-translate-y-5');
                    setTimeout(() => msg.classList.add('opacity-0', '-translate-y-5'), 2000);
                });
            }

            // --- Event Listeners Setup ---
            function setupEventListeners() {
                elements.toggleFiltersBtn.addEventListener('click', () => elements.filterPanel.classList.toggle('hidden'));
                
                elements.toggleFavoritesBtn.addEventListener('click', () => {
                    showingFavoritesOnly = !showingFavoritesOnly;
                    elements.toggleFavoritesBtn.classList.toggle('active');
                    if (showingFavoritesOnly) {
                        elements.filterPanel.classList.add('hidden');
                        elements.toggleFiltersBtn.classList.remove('active');
                    }
                    applyAndDisplay();
                });

                elements.searchInput.addEventListener('input', () => {
                    elements.clearSearchBtn.classList.toggle('hidden', !elements.searchInput.value);
                    applyAndDisplay();
                });

                elements.clearSearchBtn.addEventListener('click', () => {
                    elements.searchInput.value = '';
                    elements.clearSearchBtn.classList.add('hidden');
                    applyAndDisplay();
                    elements.searchInput.focus();
                });

                elements.filtersContainer.addEventListener('click', e => {
                    const target = e.target.closest('button.filter-btn');
                    if (!target) return;
                    const group = target.parentElement;
                    const category = group.dataset.category;
                    const filter = target.dataset.filter;
                    const isMulti = group.dataset.multiselect === 'true';

                    target.classList.toggle('active');
                    if (isMulti) {
                        if (activeFilters[category].has(filter)) activeFilters[category].delete(filter);
                        else activeFilters[category].add(filter);
                    } else {
                        if (target.classList.contains('active')) {
                            activeFilters[category].clear();
                            activeFilters[category].add(filter);
                            group.querySelectorAll('.active').forEach(btn => { if(btn !== target) btn.classList.remove('active'); });
                        } else {
                            activeFilters[category].delete(filter);
                        }
                    }
                    applyAndDisplay();
                });

                elements.appsContainer.addEventListener('click', e => {
                    const favBtn = e.target.closest('.favorite-btn');
                    if (favBtn) {
                        e.preventDefault();
                        const key = favBtn.dataset.key;
                        const svg = favBtn.querySelector('svg');
                        if (favorites.has(key)) {
                            favorites.delete(key);
                            svg.classList.remove('text-red-500', 'fill-red-500');
                            svg.classList.add('text-gray-400');
                            svg.setAttribute('fill', 'none');
                        } else {
                            favorites.add(key);
                            svg.classList.add('text-red-500', 'fill-red-500');
                            svg.classList.remove('text-gray-400');
                            svg.setAttribute('fill', 'currentColor');
                        }
                        saveFavorites();
                        if(showingFavoritesOnly) applyAndDisplay();
                        return;
                    }

                    const keywordTag = e.target.closest('.keyword-tag');
                    if (keywordTag) {
                        e.preventDefault();
                        const keyword = keywordTag.dataset.keyword;
                        if (activeFilters.palabras_clave.has(keyword)) activeFilters.palabras_clave.delete(keyword);
                        else activeFilters.palabras_clave.add(keyword);
                        applyAndDisplay();
                        return;
                    }

                    const filterLink = e.target.closest('.filter-link');
                    if (filterLink) {
                        e.preventDefault();
                        const { category, filter, multiselect } = filterLink.dataset;
                        handleFilterClick(category, filter, multiselect === 'true');
                    }
                });
                
                elements.activeFiltersDisplay.addEventListener('click', e => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const { category, filter } = target.dataset;
                    if (activeFilters[category] && activeFilters[category].has(filter)) {
                        activeFilters[category].delete(filter);
                        document.querySelector(`[data-category="${category}"] [data-filter="${filter}"]`)?.classList.remove('active');
                        applyAndDisplay();
                    }
                });
                
                document.getElementById('reset-filters-btn').addEventListener('click', () => resetAllFilters({ preserveSearch: true }));
                document.getElementById('clear-all-btn').addEventListener('click', () => resetAllFilters());
                document.getElementById('share-url-btn').addEventListener('click', () => copyToClipboard(generateShareableURL()));
                document.getElementById('help-btn').addEventListener('click', () => document.getElementById('help-modal').classList.remove('hidden'));
                document.getElementById('close-help-btn').addEventListener('click', () => document.getElementById('help-modal').classList.add('hidden'));
                document.getElementById('help-modal').addEventListener('click', e => { if (e.target.id === 'help-modal') e.currentTarget.classList.add('hidden'); });
            }

            // --- Main Execution ---
            if (SCRIPT_URL === 'PASTE_YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                elements.loadingMsg.innerHTML = '<p class="text-lg text-red-600 font-semibold">Error de configuración</p><p class="text-sm text-gray-500">Debes pegar la URL de tu Google Apps Script en la variable SCRIPT_URL del código HTML.</p>';
                return;
            }

            loadFavorites();
            
            fetch(SCRIPT_URL)
                .then(res => res.json())
                .then(data => {
                    elements.loadingMsg.style.display = 'none';
                    allApps = data.filter(app => app && app.url_app && app.titulo_app); // Filtro extra de seguridad
                    if (allApps.length > 0) {
                        setupFilters(allApps);
                        setupEventListeners();
                        applyFiltersFromURL();
                        applyAndDisplay();
                    } else {
                        elements.noResultsMsg.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error("Error al cargar datos desde el script:", error);
                    elements.loadingMsg.style.display = 'none';
                    elements.errorMsg.classList.remove('hidden');
                });
        });
    </script>
</body>
</html>
