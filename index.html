<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio de aplicaciones educativas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-top-width: 4px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .filter-btn {
            transition: all 0.2s ease-in-out;
            border: 1px solid #d1d5db; /* gray-300 */
        }
        .filter-btn.active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
            border-color: #3b82f6; /* blue-600 */
        }
        .filter-btn:not(.active):hover {
            background-color: #f3f4f6; /* gray-100 */
            border-color: #9ca3af; /* gray-400 */
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] summary .arrow {
            transform: rotate(90deg);
        }
        .keyword-tag {
            cursor: pointer;
        }
        .keyword-tag:hover, .keyword-tag.active {
            background-color: #38bdf8; /* sky-500 */
            color: white;
        }
        .filter-link {
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
            color: #4b5563; /* gray-600 */
        }
        .filter-link:hover {
            color: #1d4ed8; /* blue-700 */
            background-color: #eff6ff; /* blue-50 */
        }
        .hidden {
            display: none;
        }
        #copy-confirm-msg {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Encabezado -->
        <header class="text-center mb-4 p-6 rounded-xl bg-gradient-to-b from-blue-50 to-gray-50">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Repositorio de aplicaciones educativas</h1>
            <p class="mt-4 text-lg text-gray-600">
                Una colección de aplicaciones y recursos educativos creados por la comunidad 
                <a href="https://t.me/vceduca" target="_blank" class="text-blue-600 hover:underline font-semibold">Vibe Coding Educativo</a>.
            </p>
            <p class="mt-2 text-sm text-gray-500">
                Para añadir tu aplicación, utiliza el enlace fijado en el grupo.
            </p>
        </header>

        <!-- Barra de Búsqueda y Filtros -->
        <div class="flex flex-col md:flex-row gap-4 items-center mb-4">
            <!-- Búsqueda libre -->
            <div class="relative w-full md:flex-grow">
                <label for="search-input" class="sr-only">Búsqueda libre</label>
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                     <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <input type="text" id="search-input" placeholder="Buscar por todos los campos..." class="w-full p-2 pl-10 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button id="clear-search-btn" title="Limpiar búsqueda" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden text-gray-500 hover:text-gray-700 focus:outline-none">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Botones de acción -->
            <div class="flex-shrink-0 flex gap-2 w-full md:w-auto">
                <button id="toggle-filters-btn" title="Mostrar/ocultar filtros" class="flex flex-grow justify-center items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                    <span>Filtros</span>
                </button>
                 <button id="help-btn" title="Ayuda sobre filtros por URL" class="flex-shrink-0 flex justify-center items-center bg-gray-500 text-white font-semibold p-2.5 rounded-lg hover:bg-gray-600 transition shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </button>
            </div>
        </div>

        <!-- Panel de Filtros (Colapsable) -->
        <div id="filter-panel" class="bg-white p-4 sm:p-6 rounded-xl shadow-sm mb-8 sticky top-4 z-10 border border-gray-200 hidden">
            <div id="filters-container" class="space-y-4">
                <!-- Las secciones de filtros se insertarán aquí -->
            </div>
            <div class="mt-6 border-t pt-4 flex justify-end">
                 <button id="reset-filters-btn" class="w-full sm:w-auto px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">Limpiar Filtros</button>
            </div>
        </div>
        
        <!-- Indicadores, Contador y Botones de Acción -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 min-h-[2rem] gap-4">
            <div id="results-counter" class="text-sm text-gray-600 font-medium order-2 sm:order-1"></div>
            <div id="actions-bar" class="hidden order-1 sm:order-2 flex items-center gap-4">
                <button id="share-url-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                    Compartir URL
                </button>
                <button id="clear-all-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                    Limpiar todo
                </button>
            </div>
        </div>
        <div id="active-filters-display" class="flex flex-wrap gap-2 mb-4"></div>

        <!-- Mensajes -->
        <div id="loading-message" class="flex flex-col items-center justify-center text-center py-20">
            <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg text-gray-600 font-semibold">Cargando aplicaciones...</p>
            <p class="text-sm text-gray-500">Un momento, por favor.</p>
        </div>
        <div id="error-message" class="hidden text-center py-10 bg-red-100 text-red-700 rounded-lg"><p class="text-lg">No se pudieron cargar los datos.</p></div>
        <div id="no-results-message" class="hidden text-center py-10"><p class="text-lg text-gray-500">No se encontraron aplicaciones que coincidan con los filtros.</p></div>

        <!-- Contenedor de las tarjetas -->
        <div id="apps-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Las tarjetas se insertarán aquí -->
        </div>
    </div>
    
    <footer class="text-center py-8 mt-12 border-t border-gray-200 text-sm text-gray-500">
        <p>
            Una iniciativa del grupo <a href="https://t.me/vceduca" target="_blank" class="text-blue-600 hover:underline font-semibold">Vibe Coding Educativo</a>.
        </p>
    </footer>

    <!-- Modal de Ayuda -->
    <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 relative overflow-y-auto max-h-[90vh]">
            <button id="close-help-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-bold mb-4">Filtrado por URL</h3>
            <div class="space-y-4 text-gray-600">
                <p>Puedes compartir un enlace a esta página con filtros ya aplicados añadiendo parámetros a la URL. La búsqueda no distingue entre mayúsculas/minúsculas ni acentos.</p>
                
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">Parámetros disponibles:</h4>
                    <ul class="list-disc list-inside space-y-2">
                        <li><code class="text-sm bg-gray-100 p-1 rounded">search</code>: Busca un texto en todos los campos.</li>
                        <li><code class="text-sm bg-gray-100 p-1 rounded">author</code>: Filtra por nombre del autor.</li>
                        <li><code class="text-sm bg-gray-100 p-1 rounded">subject</code>: Filtra por área de conocimiento.</li>
                        <li><code class="text-sm bg-gray-100 p-1 rounded">level</code>: Filtra por nivel educativo.</li>
                        <li><code class="text-sm bg-gray-100 p-1 rounded">type</code>: Filtra por tipo de recurso.</li>
                        <li><code class="text-sm bg-gray-100 p-1 rounded">platform</code>: Filtra por plataforma.</li>
                        <li><code class="text-sm bg-gray-100 p-1 rounded">keyword</code>: Filtra por palabra clave.</li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">Combinar filtros:</h4>
                    <p class="mb-2">Puedes seleccionar varios valores para una categoría separándolos por comas, y combinar distintas categorías con el símbolo `&`.</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li>Varios valores para una categoría (p.ej. nivel):<br><code class="text-sm bg-gray-100 p-1 rounded">?level=Primaria,Secundaria</code></li>
                        <li>Distintas categorías (p.ej. autor y área):<br><code class="text-sm bg-gray-100 p-1 rounded">?author=Juan Perez&subject=Matematicas</code></li>
                        <li>Combinación de todo:<br><code class="text-sm bg-gray-100 p-1 rounded break-all">?author=Maria Lopez&level=Secundaria,Bachillerato&keyword=juego</code></li>
                    </ul>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Mensaje de confirmación de copia -->
    <div id="copy-confirm-msg" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-sm py-2 px-4 rounded-full opacity-0 -translate-y-5 pointer-events-none">
        ¡URL copiada al portapapeles!
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSj_hltRI4Q0QolINWJVcKxCMMjfpdiCkKzSdgp9d8RlGTdUU1UIKvaj-TBSkq0JQGneDhfUkSQuFzy/pub?output=csv';
            
            const REQUIRED_FIELDS = ['correo_autor', 'nombre_autor', 'titulo_app', 'url_app'];
            let allApps = [];
            let activeFilters = {
                area_conocimiento: new Set(),
                nivel_educativo: new Set(),
                tipo_recurso: new Set(),
                plataforma: new Set(),
                nombre_autor: new Set(),
                palabras_clave: new Set(),
            };
            
            function normalizeString(str) {
                if (!str) return '';
                return str
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "");
            }

            Papa.parse(CSV_URL, {
                download: true, header: false, skipEmptyLines: true,
                complete: (results) => {
                    document.getElementById('loading-message').style.display = 'none';
                    allApps = processData(results.data);
                    if(allApps.length > 0) {
                        setupFilters(allApps);
                        applyFiltersFromURL();
                        displayApps(applyFilters());
                    } else {
                        document.getElementById('no-results-message').classList.remove('hidden');
                    }
                },
                error: (error) => {
                    console.error("Error al cargar o parsear el CSV:", error);
                    document.getElementById('loading-message').style.display = 'none';
                    document.getElementById('error-message').classList.remove('hidden');
                }
            });

            function processData(data) {
                const FULL_COLUMN_KEYS = [
                    'timestamp', 'correo_autor', 'nombre_autor', 'titulo_app', 'url_app', 
                    'descripcion_app', 'plataforma', 'tipo_recurso', 'nivel_educativo', 
                    'area_conocimiento', 'palabras_clave', 'licencia', 'eliminar_registro'
                ];
                
                const rows = data.slice(1);
                
                const mappedData = rows.map(rowArray => {
                    const newRow = {};
                    FULL_COLUMN_KEYS.forEach((key, index) => {
                        if (rowArray[index] !== undefined) {
                            newRow[key] = rowArray[index].trim();
                        }
                    });
                    return newRow;
                });

                const keysToDelete = new Set();
                mappedData.forEach(app => {
                    if (app.eliminar_registro && normalizeString(app.eliminar_registro) === 'si' && app.url_app && app.correo_autor) {
                        const key = `${app.correo_autor.toLowerCase().trim()}|${app.url_app.trim()}`;
                        keysToDelete.add(key);
                    }
                });

                const appsWithoutDeleted = mappedData.filter(app => {
                    if (!app.url_app || !app.correo_autor) return true;
                    const key = `${app.correo_autor.toLowerCase().trim()}|${app.url_app.trim()}`;
                    return !keysToDelete.has(key);
                });

                const validApps = appsWithoutDeleted.filter(app => {
                    const missingFields = REQUIRED_FIELDS.filter(field => !app[field]);
                    if (missingFields.length > 0) return false;
                    try {
                        new URL(app.url_app);
                        return true;
                    } catch (_) {
                        return false;
                    }
                });
                
                const seenEmailTitle = new Set();
                const finalData = [];
                for (let i = validApps.length - 1; i >= 0; i--) {
                    const app = validApps[i];
                    const emailTitleKey = `${app.correo_autor.toLowerCase().trim()}|${app.titulo_app.toLowerCase().trim()}`;
                    if (!seenEmailTitle.has(emailTitleKey)) {
                        seenEmailTitle.add(emailTitleKey);
                        finalData.push(app);
                    }
                }
                
                return finalData;
            }
            
            function getPlatformStyle(platform) {
                const PLATFORM_STYLES = {
                    'Gemini': { color: 'border-purple-500' }, 'Claude': { color: 'border-orange-500' },
                    'ChatGPT': { color: 'border-teal-500' }, 'Web (HTML/JS propio)': { color: 'border-blue-500' },
                    'GitHub Pages': { color: 'border-black' }, 'Google Sites': { color: 'border-sky-500' },
                    'Default': { color: 'border-gray-400' }
                };
                if (!platform) return PLATFORM_STYLES.Default;
                const key = Object.keys(PLATFORM_STYLES).find(k => platform.includes(k) && k !== 'Default');
                return PLATFORM_STYLES[key] || PLATFORM_STYLES.Default;
            }

            function setupFilters(apps) {
                const filtersContainer = document.getElementById('filters-container');
                const filterCategories = [
                    { id: 'area_conocimiento', name: 'Área de Conocimiento', multiSelect: true, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>' },
                    { id: 'nivel_educativo', name: 'Nivel Educativo', multiSelect: true, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 1.7.9 3.2 2.3 4.1"/><path d="M16 17a3 3 0 0 0-3-3 3 3 0 0 0-3 3v2h6v-2Z"/></svg>' },
                    { id: 'tipo_recurso', name: 'Tipo de Recurso', multiSelect: true, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.28 2.22a2.22 2.22 0 0 0-3.14 0l-12 12a2.22 2.22 0 0 0 0 3.14l3.14 3.14a2.22 2.22 0 0 0 3.14 0l12-12a2.22 2.22 0 0 0 0-3.14Z"/><path d="m14 7 3 3"/><path d="M5.5 16.5 10 12"/></svg>' },
                    { id: 'plataforma', name: 'Plataforma', multiSelect: false, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>'},
                    { id: 'nombre_autor', name: 'Autor', multiSelect: false, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'},
                ];

                filterCategories.forEach(cat => {
                    const values = new Set();
                    apps.forEach(app => {
                        app[cat.id]?.split(',').forEach(val => {
                            const trimmedValue = val.trim();
                            if (trimmedValue) values.add(trimmedValue);
                        });
                    });
                    
                    const sortedValues = Array.from(values).sort();
                    if (sortedValues.length === 0) return;

                    const details = document.createElement('details');
                    details.className = 'border-b border-gray-200 last:border-b-0 pb-4';
                    details.innerHTML = `
                        <summary class="flex justify-between items-center cursor-pointer py-2">
                            <div class="flex items-center gap-3"><span class="text-gray-500">${cat.icon}</span><span class="font-semibold text-gray-800">${cat.name}</span></div>
                            <span class="arrow transition-transform text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></span>
                        </summary>
                        <div class="pt-3 flex flex-wrap gap-2 button-group" data-category="${cat.id}" data-multiselect="${cat.multiSelect}">
                            ${sortedValues.map(value => `<button class="filter-btn text-sm font-medium py-1.5 px-3 rounded-full" data-filter="${value}">${value}</button>`).join('')}
                        </div>`;
                    filtersContainer.appendChild(details);
                });

                filtersContainer.addEventListener('click', e => {
                    const target = e.target.closest('button.filter-btn');
                    if (!target) return;
                    
                    const group = target.parentElement;
                    const category = group.dataset.category;
                    const filter = target.dataset.filter;
                    const isMultiSelect = group.dataset.multiselect === 'true';

                    if (isMultiSelect) {
                        target.classList.toggle('active');
                        if (activeFilters[category].has(filter)) activeFilters[category].delete(filter);
                        else activeFilters[category].add(filter);
                    } else {
                        if (target.classList.contains('active')) {
                            target.classList.remove('active');
                            activeFilters[category].delete(filter);
                        } else {
                             group.querySelectorAll('.active').forEach(btn => btn.classList.remove('active'));
                             target.classList.add('active');
                             activeFilters[category].clear();
                             activeFilters[category].add(filter);
                        }
                    }
                    displayApps(applyFilters());
                });
            }

            function createFilterLink(text, category, isMultiSelect) {
                const values = text.split(',').map(v => v.trim()).filter(Boolean);
                return values.map(value => 
                    `<a href="#" class="filter-link" data-category="${category}" data-filter="${value}" data-multiselect="${isMultiSelect}">${value}</a>`
                ).join(', ');
            }

            function displayApps(apps) {
                const container = document.getElementById('apps-container');
                const counter = document.getElementById('results-counter');
                container.innerHTML = '';
                document.getElementById('no-results-message').classList.toggle('hidden', apps.length > 0);
                counter.textContent = `Mostrando ${apps.length} de ${allApps.length} aplicaciones.`;

                const activeKeywords = activeFilters.palabras_clave;

                apps.forEach(app => {
                    const card = document.createElement('div');
                    const style = getPlatformStyle(app.plataforma);
                    card.className = `card bg-white rounded-lg shadow-sm overflow-hidden flex flex-col ${style.color}`;
                    
                    const keywordsHtml = app.palabras_clave ? app.palabras_clave.split(',').filter(k => k.trim()).map(k => {
                        const keyword = k.trim();
                        const isActive = activeKeywords.has(keyword);
                        return `<span class="keyword-tag ${isActive ? 'active' : ''} bg-sky-100 text-sky-800 text-xs font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full" data-keyword="${keyword}">${keyword}</span>`;
                    }).join('') : '';

                    const autorHtml = `por <span class="font-medium">${createFilterLink(app.nombre_autor, 'nombre_autor', false)}</span>`;
                    const nivelHtml = app.nivel_educativo ? `<p><strong>Nivel:</strong> ${createFilterLink(app.nivel_educativo, 'nivel_educativo', true)}</p>` : '';
                    const areaHtml = app.area_conocimiento ? `<p><strong>Área:</strong> ${createFilterLink(app.area_conocimiento, 'area_conocimiento', true)}</p>` : '';
                    const licenciaHtml = app.licencia ? `<p><strong>Licencia:</strong> ${app.licencia}</p>` : '';

                    card.innerHTML = `
                        <div class="p-5 flex-grow flex flex-col">
                            <p class="text-sm font-semibold text-gray-600 mb-3">${app.plataforma || 'Sin plataforma'}</p>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${app.titulo_app}</h3>
                            <p class="text-sm text-gray-500 mb-3">${autorHtml}</p>
                            <p class="text-gray-600 text-sm mb-4 flex-grow">${app.descripcion_app || 'No hay descripción.'}</p>
                            <div class="text-xs text-gray-500 space-y-1 mt-auto">
                                ${nivelHtml}
                                ${areaHtml}
                                ${licenciaHtml}
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-200 bg-gray-50">
                             <div class="flex flex-wrap mb-3 min-h-[2rem]">${keywordsHtml}</div>
                            <a href="${app.url_app}" target="_blank" class="block w-full text-center bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Visitar Aplicación
                            </a>
                        </div>`;
                    container.appendChild(card);
                });
            }
            
            function resetAllFilters(options = {}) {
                if (!options.preserveSearch) {
                    document.getElementById('search-input').value = '';
                    document.getElementById('clear-search-btn').classList.add('hidden');
                }
                for (const category in activeFilters) {
                    activeFilters[category].clear();
                }
                document.querySelectorAll('.filter-btn.active').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('#filters-container details').forEach(detail => {
                    detail.open = false;
                });
                
                displayApps(applyFilters());
            }

            function applyFilters() {
                const searchText = normalizeString(document.getElementById('search-input').value);
                
                const filteredApps = allApps.filter(app => {
                    const searchMatch = searchText === '' || 
                        normalizeString(Object.values(app).join(' ')).includes(searchText);

                    if (!searchMatch) return false;

                    for (const category in activeFilters) {
                        const selected = activeFilters[category];
                        if (selected.size === 0) continue;
                        
                        const appValueString = app[category] ? normalizeString(app[category]) : '';
                        if (!appValueString) return false;
                        
                        const match = [...selected].every(filterVal => {
                            const normalizedFilter = normalizeString(filterVal);
                            return appValueString.split(',').map(s => normalizeString(s.trim())).includes(normalizedFilter);
                        });

                        if (!match) return false;
                    }
                    return true;
                });
                updateActiveFiltersDisplay();
                return filteredApps;
            }
            
            function updateActiveFiltersDisplay() {
                const activeFiltersContainer = document.getElementById('active-filters-display');
                const actionsBar = document.getElementById('actions-bar');
                activeFiltersContainer.innerHTML = '';
                let hasActiveFilter = false;

                Object.entries(activeFilters).forEach(([category, filterSet]) => {
                    if(filterSet.size === 0) return;
                    hasActiveFilter = true;

                    const catName = document.querySelector(`[data-category="${category}"]`)?.closest('details')?.querySelector('summary .font-semibold')?.textContent || 'Palabra Clave';
                    filterSet.forEach(filterValue => {
                        const tag = document.createElement('div');
                        tag.className = 'flex items-center bg-gray-200 text-gray-800 text-sm font-medium pl-3 pr-2 py-1 rounded-full';
                        tag.innerHTML = `
                            <span>${catName}: ${filterValue}</span>
                            <button class="ml-2 text-gray-500 hover:text-gray-800" data-category="${category}" data-filter="${filterValue}" title="Eliminar filtro">&times;</button>
                        `;
                        activeFiltersContainer.appendChild(tag);
                    });
                });
                const hasSearchText = document.getElementById('search-input').value.length > 0;
                actionsBar.classList.toggle('hidden', !hasActiveFilter && !hasSearchText);
            }
            
            const paramMapping = {
                subject: 'area_conocimiento', level: 'nivel_educativo', type: 'tipo_recurso',
                platform: 'plataforma', author: 'nombre_autor', keyword: 'palabras_clave',
                search: 'search'
            };

            function applyFiltersFromURL() {
                const params = new URLSearchParams(window.location.search);
                
                params.forEach((value, key) => {
                    const mappedKey = key.toLowerCase();
                    const category = paramMapping[mappedKey];
                    if (!category) return;
                    
                    const valuesFromUrl = value.split(',');
                    if (category === 'search') {
                        const searchInput = document.getElementById('search-input');
                        searchInput.value = value;
                        document.getElementById('clear-search-btn').classList.toggle('hidden', !searchInput.value);
                    } else if (activeFilters[category]) {
                         valuesFromUrl.forEach(urlVal => {
                            activeFilters[category].add(urlVal);
                            const normalizedUrlVal = normalizeString(urlVal);
                            const buttons = document.querySelectorAll(`[data-category="${category}"] .filter-btn`);
                            buttons.forEach(btn => {
                                const normalizedBtnFilter = normalizeString(btn.dataset.filter);
                                if (normalizedBtnFilter.includes(normalizedUrlVal)) btn.classList.add('active');
                            });
                        });
                    }
                });
            }
            
            function handleFilterClick(category, filter, isMultiSelect) {
                const filterSet = activeFilters[category];
                if (!filterSet) return;
                
                if (isMultiSelect) {
                    if (!filterSet.has(filter)) {
                        filterSet.add(filter);
                    }
                } else {
                    filterSet.clear();
                    filterSet.add(filter);
                }
                
                const btn = document.querySelector(`.filter-btn[data-category="${category}"][data-filter="${filter}"]`);
                if(btn) {
                     if (!isMultiSelect) {
                        btn.parentElement.querySelectorAll('.active').forEach(b => b.classList.remove('active'));
                     }
                     btn.classList.add('active');
                }

                displayApps(applyFilters());
            }

            function generateShareableURL() {
                const baseURL = window.location.origin + window.location.pathname;
                const params = new URLSearchParams();
                
                const reverseParamMapping = Object.fromEntries(Object.entries(paramMapping).map(a => a.reverse()));

                const searchText = document.getElementById('search-input').value;
                if (searchText) {
                    params.set('search', searchText);
                }

                for (const category in activeFilters) {
                    if (activeFilters[category].size > 0) {
                        const paramName = reverseParamMapping[category];
                        if (paramName) {
                            params.set(paramName, [...activeFilters[category]].join(','));
                        }
                    }
                }
                return `${baseURL}?${params.toString()}`;
            }

            function copyToClipboard(text) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    return navigator.clipboard.writeText(text);
                }
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed'; 
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
                document.body.removeChild(textArea);
            }

            // --- Controladores de eventos ---
            document.getElementById('toggle-filters-btn').addEventListener('click', () => document.getElementById('filter-panel').classList.toggle('hidden'));
            document.getElementById('help-btn').addEventListener('click', () => document.getElementById('help-modal').classList.remove('hidden'));
            document.getElementById('close-help-btn').addEventListener('click', () => document.getElementById('help-modal').classList.add('hidden'));
            document.getElementById('help-modal').addEventListener('click', (e) => {
                if (e.target.id === 'help-modal') document.getElementById('help-modal').classList.add('hidden');
            });

            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');

            searchInput.addEventListener('input', () => {
                clearSearchBtn.classList.toggle('hidden', !searchInput.value);
                displayApps(applyFilters());
            });

            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearSearchBtn.classList.add('hidden');
                displayApps(applyFilters());
                searchInput.focus();
            });
            
            document.getElementById('reset-filters-btn').addEventListener('click', () => resetAllFilters());
            document.getElementById('clear-all-btn').addEventListener('click', () => resetAllFilters());
            
            document.getElementById('share-url-btn').addEventListener('click', () => {
                const url = generateShareableURL();
                copyToClipboard(url);
                const msg = document.getElementById('copy-confirm-msg');
                msg.classList.remove('opacity-0', '-translate-y-5');
                setTimeout(() => {
                    msg.classList.add('opacity-0', '-translate-y-5');
                }, 2000);
            });
            
            document.getElementById('apps-container').addEventListener('click', e => {
                const keywordTarget = e.target.closest('.keyword-tag');
                if (keywordTarget) {
                    e.preventDefault();
                    const keyword = keywordTarget.dataset.keyword;
                    if(activeFilters.palabras_clave.has(keyword)) {
                        activeFilters.palabras_clave.delete(keyword);
                    } else {
                        activeFilters.palabras_clave.add(keyword);
                    }
                    displayApps(applyFilters());
                    return;
                }

                const filterLinkTarget = e.target.closest('.filter-link');
                if (filterLinkTarget) {
                    e.preventDefault();
                    const category = filterLinkTarget.dataset.category;
                    const filter = filterLinkTarget.dataset.filter;
                    const isMultiSelect = filterLinkTarget.dataset.multiselect === 'true';
                    handleFilterClick(category, filter, isMultiSelect);
                }
            });
            
             document.getElementById('active-filters-display').addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;

                const { category, filter } = target.dataset;
                
                if (activeFilters[category] && activeFilters[category].has(filter)) {
                    activeFilters[category].delete(filter);
                    const btn = document.querySelector(`[data-category="${category}"] [data-filter="${filter}"]`);
                    if (btn) btn.classList.remove('active');
                    
                    displayApps(applyFilters());
                }
            });
        });
    </script>
</body>
</html>
